<!DOCTYPE html>
<html class="light" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>LaborPortal - Jobs</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script id="tailwind-config">
      tailwind.config = { darkMode: "class", theme: { extend: { colors: { primary: "#137fec", "background-light": "#f6f7f8", "background-dark": "#101922" }, fontFamily: { display: ["Inter", "sans-serif"] }, borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" } } } };
    </script>
    <style> body { min-height: max(884px, 100dvh); } </style>
  </head>
  <body class="font-display bg-background-light dark:bg-background-dark">
    <div class="relative flex min-h-screen w-full flex-col group/design-root overflow-x-hidden">
      <div class="sticky top-0 z-10 bg-background-light dark:bg-background-dark pt-4">
        <div class="flex items-center px-4 pb-2 justify-between">
          <h1 class="text-2xl font-bold leading-tight tracking-[-0.015em] flex-1 text-slate-900 dark:text-white">Available Jobs</h1>
          <div class="flex items-center gap-2">
            <div id="user-chip" class="hidden items-center gap-2 px-3 py-1 rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-sm">
              <span class="material-symbols-outlined">account_circle</span>
              <span id="user-name"></span>
            </div>
            <button id="my-jobs-btn" class="text-sm px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-slate-900 dark:text-white">My Jobs</button>
            <button id="logout-btn" class="hidden text-sm px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-slate-900 dark:text-white">Logout</button>
          </div>
        </div>
        <div class="px-4 pb-3">
          <label class="flex flex-col min-w-40 h-12 w-full">
            <div class="flex w-full items-stretch rounded-xl h-full">
              <div class="text-slate-500 dark:text-slate-400 flex border-none bg-white dark:bg-slate-800 items-center justify-center pl-4 rounded-l-xl">
                <span class="material-symbols-outlined">search</span>
              </div>
              <input id="search" class="form-input flex w-full flex-1 overflow-hidden rounded-xl text-slate-900 dark:text-white border-none bg-white dark:bg-slate-800 h-full placeholder:text-slate-500 dark:placeholder:text-slate-400 px-4 rounded-l-none" placeholder="Search for jobs..." />
            </div>
          </label>
        </div>
      </div>
      <div class="px-4 pb-2">
        <div class="flex items-center gap-2">
          <label class="text-sm text-slate-600 dark:text-slate-300">Sort:</label>
          <select id="sort" class="form-select h-10 rounded-lg bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 text-sm text-slate-800 dark:text-white px-3">
            <option value="relevance">Relevance</option>
            <option value="priceAsc">Cost: Low → High</option>
            <option value="priceDesc">Cost: High → Low</option>
            <option value="dateAsc">Start Date: Soonest</option>
            <option value="dateDesc">Start Date: Latest</option>
          </select>
        </div>
      </div>
      <div id="jobs" class="flex flex-col gap-3 px-4 pb-20"></div>
      <div id="recruiter-bar" class="fixed bottom-0 inset-x-0 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 p-3">
        <div class="flex items-center justify-center">
          <a href="./recruiter-login.html" class="text-sm text-slate-700 dark:text-slate-200">Are you a recruiter? <span class="text-primary font-semibold underline">Sign in</span></a>
        </div>
      </div>
    </div>
    <div id="apply-modal" class="hidden fixed inset-0 z-20 bg-black/40 flex items-end sm:items-center justify-center p-4">
      <div class="w-full max-w-md bg-white dark:bg-slate-800 rounded-xl shadow-lg p-4">
        <h3 id="apply-title" class="text-lg font-bold text-slate-900 dark:text-white mb-2">Sign in to continue</h3>
        <div class="flex flex-col gap-3">
          <input id="app-name" class="form-input h-12 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900/40 text-slate-900 dark:text-white px-4" placeholder="Your full name" />
          <input id="app-contact" inputmode="numeric" pattern="\\d{10}" maxlength="10" class="form-input h-12 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900/40 text-slate-900 dark:text-white px-4" placeholder="10-digit contact number" />
          <input id="app-passkey" type="password" class="form-input h-12 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900/40 text-slate-900 dark:text-white px-4" placeholder="Passkey (1234)" />
          <p id="app-error" class="text-sm text-red-600 hidden">Please fill all fields. Contact must be 10 digits. Passkey must be 1234.</p>
        </div>
        <div class="flex gap-2 justify-end mt-4">
          <button id="app-cancel" class="px-4 h-10 rounded-lg bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-white">Cancel</button>
          <button id="app-submit" class="px-4 h-10 rounded-lg bg-primary text-white">Submit</button>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.2"></script>
    <script src="./js/supabaseClient.js"></script>
    <script src="./js/storage.js"></script>
    <script>
      (async function init() {
        await LPStorage.ensureSeedData();
        const jobsEl = document.getElementById("jobs");
        const searchEl = document.getElementById("search");
        const sortEl = document.getElementById("sort");
        let pendingJobId = null;

        function getLaborSession() {
          const s = LPStorage.getSession();
          return s && s.role === "laborer" && s.contact ? s : null;
        }
        function refreshUserChip() {
          const s = getLaborSession();
          const chip = document.getElementById("user-chip");
          const nameEl = document.getElementById("user-name");
          const logoutBtn = document.getElementById("logout-btn");
          if (s) {
            nameEl.textContent = s.name;
            chip.classList.remove("hidden");
            document.getElementById("recruiter-bar").classList.add("hidden");
            logoutBtn.classList.remove("hidden");
          } else {
            chip.classList.add("hidden");
            nameEl.textContent = "";
            document.getElementById("recruiter-bar").classList.remove("hidden");
            logoutBtn.classList.add("hidden");
          }
        }

        async function renderList(filterText) {
          jobsEl.innerHTML = "";
          const allOpen = await LPStorage.getOpenJobs();
          let jobs = filterText ? allOpen.filter(j => (j.title + " " + j.description).toLowerCase().includes(filterText.toLowerCase())) : allOpen;
          const session = getLaborSession();
          if (session) {
            jobs = jobs.filter(j => !j.applicants.some(a => (a.contact && a.contact === session.contact) || (a.user && a.user === session.username)));
          }
          const sort = sortEl.value;
          jobs = jobs.slice().sort((a, b) => {
            if (sort === "priceAsc") return (a.pricePerHour || 0) - (b.pricePerHour || 0);
            if (sort === "priceDesc") return (b.pricePerHour || 0) - (a.pricePerHour || 0);
            const da = a.startDateTime ? Date.parse(a.startDateTime) : Date.parse(a.createdAt || 0);
            const db = b.startDateTime ? Date.parse(b.startDateTime) : Date.parse(b.createdAt || 0);
            if (sort === "dateAsc") return da - db;
            if (sort === "dateDesc") return db - da;
            return 0;
          });
          if (jobs.length === 0) {
            const empty = document.createElement("div");
            empty.className = "text-center py-16 px-6 text-gray-500";
            empty.textContent = "No jobs found.";
            jobsEl.appendChild(empty);
            return;
          }
          jobs.forEach(job => {
            const hired = job.applicants.length;
            const card = document.createElement("div");
            card.className = "flex flex-col rounded-xl bg-white dark:bg-slate-800 shadow";
            card.innerHTML = `
              <div class="p-4 flex flex-col gap-2">
                <p class="text-lg font-bold text-slate-900 dark:text-white">${job.title}</p>
                <p class="text-slate-600 dark:text-slate-300">${job.description}</p>
                <div class="text-sm text-slate-600 dark:text-slate-300 flex flex-wrap gap-4">
                  ${job.location ? `<span class="flex items-center gap-1"><span class="material-symbols-outlined text-base">location_on</span>${job.location}</span>` : ``}
                  ${job.startDateTime ? `<span class="flex items-center gap-1"><span class="material-symbols-outlined text-base">calendar_month</span>${new Date(job.startDateTime).toLocaleString()}</span>` : ``}
                </div>
                <div class="flex items-center gap-4 text-sm text-slate-600 dark:text-slate-300 pt-1">
                  <div class="flex items-center gap-1.5"><span class="material-symbols-outlined text-lg">payments</span><span>₹${job.pricePerHour} / hour</span></div>
                  <div class="flex items-center gap-1.5"><span class="material-symbols-outlined text-lg">groups</span><span>${hired} of ${job.requiredCount} hired</span></div>
                </div>
              </div>
              <div class="border-t border-slate-200 dark:border-slate-700 p-4">
                <button data-id="${job.id}" class="apply-btn flex w-full items-center justify-center rounded-lg h-10 px-4 bg-primary hover:bg-primary/90 text-white text-sm font-medium"><span class="truncate">Sign Up</span></button>
              </div>
            `;
            jobsEl.appendChild(card);
          });
          jobsEl.querySelectorAll(".apply-btn").forEach(btn => {
            btn.addEventListener("click", async () => {
              pendingJobId = btn.getAttribute("data-id");
              const labor = getLaborSession();
              if (labor) {
                const res = await LPStorage.applyToJobWithDetails(pendingJobId, { name: labor.name, contact: labor.contact, passkey: "1234" });
                if (!res.ok) { alert(res.error || "Could not sign up."); return; }
                await renderList(searchEl.value);
                alert("Successfully signed up!");
              } else {
                openApplyModal();
              }
            });
          });
        }

        function openApplyModal() {
          document.getElementById("app-name").value = "";
          document.getElementById("app-contact").value = "";
          document.getElementById("app-passkey").value = "";
          document.getElementById("app-error").classList.add("hidden");
          document.getElementById("apply-modal").classList.remove("hidden");
        }
        function closeApplyModal() { document.getElementById("apply-modal").classList.add("hidden"); }
        document.getElementById("app-contact").addEventListener("input", (e) => { e.target.value = e.target.value.replace(/\\D+/g, "").slice(0, 10); });
        document.getElementById("app-cancel").addEventListener("click", closeApplyModal);
        document.getElementById("app-submit").addEventListener("click", async () => {
          const name = document.getElementById("app-name").value.trim();
          const contact = document.getElementById("app-contact").value.trim();
          const passkey = document.getElementById("app-passkey").value;
          const err = document.getElementById("app-error");
          if (!name || !contact || !passkey) { err.textContent = "Please fill all fields."; err.classList.remove("hidden"); return; }
          const loginRes = await LPStorage.loginLabor(name, contact, passkey);
          if (!loginRes.ok) { err.textContent = loginRes.error || "Login failed."; err.classList.remove("hidden"); return; }
          if (pendingJobId) {
            const res = await LPStorage.applyToJobWithDetails(pendingJobId, { name, contact, passkey });
            if (!res.ok) { err.textContent = res.error || "Could not sign up."; err.classList.remove("hidden"); return; }
            closeApplyModal();
            await renderList(searchEl.value);
            alert("Successfully signed up!");
          } else {
            closeApplyModal();
            window.location.href = "./my-jobs.html";
          }
          refreshUserChip();
        });

        searchEl.addEventListener("input", (e) => renderList(e.target.value));
        sortEl.addEventListener("change", () => renderList(searchEl.value));
        await renderList("");

        document.getElementById("my-jobs-btn").addEventListener("click", () => {
          const labor = getLaborSession();
          if (labor) { window.location.href = "./my-jobs.html"; }
          else { pendingJobId = null; openApplyModal(); }
        });
        document.getElementById("logout-btn").addEventListener("click", async () => {
          LPStorage.logout();
          refreshUserChip();
          await renderList(searchEl.value);
        });
        refreshUserChip();
      })();
    </script>
  </body>
</html>

